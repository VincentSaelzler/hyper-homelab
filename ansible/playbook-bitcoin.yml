---
# based on https://jonatack.github.io/articles/how-to-compile-bitcoin-core-and-run-the-tests
- name: Install Bitcoin
  hosts: bitcoin
  become: yes
  tasks:
  - name: Install dependencies
    apt:
      pkg:
      - build-essential
      - libtool
      - autotools-dev
      - automake
      - pkg-config
      - bsdmainutils
      - python3
      - libssl-dev
      - libevent-dev
      - libboost-system-dev
      - libboost-filesystem-dev
      - libboost-chrono-dev
      - libboost-test-dev
      - libboost-thread-dev
      - libminiupnpc-dev
      - libzmq3-dev
      - libqt5gui5
      - libqt5core5a
      - libqt5dbus5
      - qttools5-dev
      - qttools5-dev-tools
      - libprotobuf-dev
      - protobuf-compiler
      - git
      - libsqlite3-dev
  - name: Reboot system if required.
    command:
      cmd: shutdown -r now 'Rebooting to complete system upgrade'
      removes: /var/run/reboot-required
  - name: Clone Bitcoin git repo
    become_user: vince
    git:
      repo: "https://github.com/bitcoin/bitcoin.git"
      dest: "~/bitcoin"
    register: git_out
  - debug:
      msg: "{{ git_out['changed'] }}"
  - name: Run script to install Bitcoin
    become_user: vince
    script: install-btc.sh
    when: git_out['changed']

  # - name: Get latest release version
  #   become_user: vince
  #   shell:
  #     chdir: "~/bitcoin"
  #     # this one-line looks complex but can be debugged easily by removing steps
  #     # each step along the way makes sense and goes from raw to polished output
  #     cmd: "git tag -n | sort -V | grep final | tail -n 1 | sed 's/ .*//'"
  #   register: git_tag
  # - name: Checkout latest release
  #   become_user: vince
  #   git:
  #     repo: "https://github.com/bitcoin/bitcoin.git"
  #     dest: "~/bitcoin"
  #     version: "{{ git_tag['stdout'] }}"
  # # - debug:
  # #     msg: "Version:{{ tag['stdout'] }}"
  # # - name: Build old version of Berkley DB
  # #   become_user: vince
  # #   command:
  # #     chdir: "~/bitcoin"
  # #     cmd: "~/bitcoin/contrib/install_db4.sh ~/bitcoin"