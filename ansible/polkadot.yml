---
# based on https://github.com/paritytech/polkadot README
- name: Install Polkadot using the package manager
  hosts: polkadot
  become: yes
  roles:
    - full-upgrade
    - personalize
    - add-user
    - ubuntu-gui
  tasks:
  - name: Add an apt key by id from a keyserver
    apt_key:
      keyserver: hkps://keys.mailvelope.com
      id: 9D4B2B6EB8F97156D19669A9FF0812D491B96798
  - name: Add specified repository into sources list
    apt_repository:
      repo: deb https://releases.parity.io/deb release main
      state: present
  - name: Install dependencies
    apt:
      pkg:
      - parity-keyring
      - polkadot
    register: apt_result
  - name: Download front-end client #does not appear to re-download if the file already exists
    become_user: "{{ usr_name }}"
    get_url:
      url: "https://github.com/polkadot-js/apps/releases/download/v0.98.1/Polkadot-JS-Apps-0.98.1.AppImage"
      dest: "~/"
      mode: "755"
  - name: Restart system if any packages were installed or upgraded
    reboot:
    when: apt_result['changed']
  - name: Set CLI flags
    lineinfile:
      path: /etc/default/polkadot
      regexp: '^POLKADOT_CLI_ARGS='
      line: POLKADOT_CLI_ARGS="--rpc-cors file:// --name '{{ node_name }}' --pruning archive""
    register: line_result
  - name: Restart polkadot service if config changes
    systemd:
      name: polkadot
      state: restarted
    when: apt_result['changed'] or line_result['changed']
  - name: Start and enable polkadot service
    systemd:
      name: polkadot
      state: started
      enabled: yes
