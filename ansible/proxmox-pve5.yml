---
# scheme: two-drive btrfs RAID1 array from installer, plus 4-drive RAID 0 mdadm array for VMs 
# cat /proc/mdstat is helpful
# dumpe2fs /dev/md0 is helpful
- name: Partition disks and configure RAID on pve5
  hosts: pve5
  tasks:

  # # Unmount and remove file systems
  # - name: Unmount the device and remove from fstab
  #   mount:
  #     path: /mnt/swraid
  #     src: "{{ mdev_name }}"
  #     state: absent
  # - name: Remove the ext4 filesystem
  #   filesystem:
  #     state: absent
  #     dev: "{{ mdev_name }}"

  # # Remove RAID
  # - name: Stop the memory device
  #   command:
  #     cmd: "mdadm --stop {{ mdev_name }}"
  #     removes: "{{ mdev_name }}"
  # - name: Remove the memory device
  #   # without the removes check, it is normal for this to return an error:
  #   # "mdadm: error opening /dev/md0: No such file or directory" 
  #   command:
  #     cmd: "mdadm --remove {{ mdev_name }}"
  #     removes: "{{ mdev_name }}"
  # - name: Remove the superblocks # shows as changed even when really no change
  #   command:
  #     cmd: "mdadm --zero-superblock {{ item }}"
  #     removes: "{{ item }}"
  #   loop: "{{ raid_parts }}"
  # - name: Remove configuration line for memory device
  #   lineinfile:
  #     path: /etc/mdadm/mdadm.conf
  #     regexp: '^ARRAY {{ mdev_name }}'
  #     state: absent

  # # Remove partitions
  # - name: Wipe all partitions
  #   command:
  #     cmd: "sgdisk {{ item }} --zap-all"
  #     removes: "{{ item }}1"
  #   loop: "{{ raid_drives }}"

  # Create partitions
  - name: Create partitions
    command:
      cmd: "sgdisk {{ item }} --new=1:0:+232G --typecode=1:fd00 --change-name=1:'Linux RAID'"
      creates: "{{ item }}1"
    loop: "{{ raid_drives }}"

  # Install dependencies and create RAID device
  - name: Install required apt packages
    apt:
      pkg:
      - mdadm
      - python3-pip
  - name: Install required python packages
    pip:
      name: pexpect
  - name: Create the memory device
    expect:
      command: mdadm --create --verbose --level=0 --raid-devices={{ raid_parts | length }} {{ mdev_name }} {{ raid_parts | join(' ') }}
      creates: "{{ mdev_name }}"
      responses:
        Continue creating array: y
  - name: Get configuration line for memory device
    command:
      cmd: "mdadm --detail --scan"
    register: mdadm_conf
    changed_when: false
  - name: Save configuration line for memory device
    lineinfile:
      path: /etc/mdadm/mdadm.conf
      regexp: '^ARRAY {{ mdev_name }}'
      insertafter: '^# definitions of existing MD arrays'
      line: "{{ mdadm_conf.stdout }}"
    notify:
    - update ram fs # suggested within documentation of mdadm.conf

  # Create and mount file system
  - name: Create an ext4 filesystem
    filesystem:
      fstype: ext4
      dev: "{{ mdev_name }}"
      opts: "-L quad -b 4096 -E stride=128,stripe-width=512"
  - name: Mount the device and add to fstab
    mount:
      path: /mnt/swraid
      src: "{{ mdev_name }}"
      fstype: ext4
      state: mounted
      passno: 2

  handlers:
  - name: update ram fs
    command: "update-initramfs -u"
